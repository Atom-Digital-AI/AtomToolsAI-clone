<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Map CSV Columns</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
        line-height: 1.6;
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
        background-color: #f5f5f5;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 2rem;
        text-align: center;
      }

      .alert-messages {
        margin-bottom: 2rem;
      }

      .alert-messages ul {
        list-style: none;
        padding: 1rem;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 4px;
        color: #856404;
      }

      form {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .form-section {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #eee;
      }

      .form-section:last-child {
        border-bottom: none;
        margin-bottom: 1.5rem;
      }

      .section-title {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        font-size: 1.2rem;
        font-weight: 500;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-weight: 500;
      }

      input[type="url"],
      input[type="text"],
      textarea,
      select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      button {
        background-color: #3498db;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #2980b9;
      }

      .required-field::after {
        content: " *";
        color: #e74c3c;
      }

      .progress-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
      }

      .step {
        display: flex;
        align-items: center;
        color: #666;
      }

      .step.active {
        color: #3498db;
        font-weight: 500;
      }

      .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: currentColor;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        font-size: 0.875rem;
      }

      .step-divider {
        width: 40px;
        height: 2px;
        background-color: #ddd;
        margin: 0 1rem;
      }

      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-text {
        color: white;
        margin-top: 1rem;
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

    <h1>Bulk Ad Generation</h1>

    <div class="progress-steps">
      <div class="step">
        <div class="step-number">1</div>
        <span>Upload CSV</span>
      </div>
      <div class="step-divider"></div>
      <div class="step active">
        <div class="step-number">2</div>
        <span>Map Columns</span>
      </div>
      <div class="step-divider"></div>
      <div class="step">
        <div class="step-number">3</div>
        <span>Generate Ads</span>
      </div>
    </div>

    {% with messages = get_flashed_messages() %} {% if messages %}
    <div class="alert-messages">
      <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %} {% endwith %}

    <form method="POST">
      <input type="hidden" name="column_mapping" value="true" />

      <div class="form-section">
        <h2 class="section-title">Map Your CSV Columns</h2>
        <div class="form-group">
          <label for="campaign_col" class="required-field"
            >Campaign Name Column</label
          >
          <select name="campaign_col" id="campaign_col" required>
            <option value="">Select column</option>
            {% for header in headers %}
            <option value="{{ header }}" 
                    {% if header == suggested.campaign_col %}selected{% endif %}>
                {{ header }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="adgroup_col" class="required-field"
            >Ad Group Name Column</label
          >
          <select name="adgroup_col" id="adgroup_col" required>
            <option value="">Select column</option>
            {% for header in headers %}
            <option value="{{ header }}"
                    {% if header == suggested.adgroup_col %}selected{% endif %}>
                {{ header }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="keyword_col" class="required-field"
            >Target Keyword Column</label
          >
          <select name="keyword_col" id="keyword_col" required>
            <option value="">Select column</option>
            {% for header in headers %}
            <option value="{{ header }}"
                    {% if header == suggested.keyword_col %}selected{% endif %}>
                {{ header }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">Ad Settings</h2>
        <div class="form-group">
          <label for="target_url" class="required-field">Target URL</label>
          <input type="url" name="target_url" id="target_url" required />
        </div>

        <div class="form-group">
          <label for="brand_name" class="required-field">Brand Name</label>
          <input type="text" name="brand_name" id="brand_name" required />
        </div>

        <div class="form-group">
          <label for="selling_points">Selling Points</label>
          <textarea
            name="selling_points"
            id="selling_points"
            placeholder="Enter your key selling points (optional)"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="case_type" class="required-field">Case Type</label>
          <select name="case_type" id="case_type" required>
            <option value="sentence">Sentence case</option>
            <option value="title">Title Case</option>
          </select>
        </div>
      </div>

      <button type="submit">Generate Bulk Ads</button>
    </form>

    <script>
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                showLoading();
                
                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                })
                .then(response => {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/csv')) {
                        response.blob().then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'ads_output.csv';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a); // Clean up
                            window.URL.revokeObjectURL(url);
                            hideLoading();
                        });
                    } else {
                        hideLoading();
                        window.location.href = response.url;
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error:', error);
                });
            });
        });
    </script>
  </body>
</html>
